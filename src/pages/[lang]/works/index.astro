---
import Footer from "@/components/Footer.astro";
import NavBar from "@/components/NavBar.astro";
import ProjectsBanner from "@/components/works/ProjectsBanner.astro";
import WorkCard from "@/components/works/WorkCard.astro";
import { languages } from "@/i18n/ui";
import { getLangFromUrl, useTranslations } from "@/i18n/utils";
import Base from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allPaths = [];
  for (const lang of Object.keys(languages)) {
    allPaths.push({
      params: { lang },
      props: { lang },
    });
  }
  return allPaths;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// ç²å–ä½œå“é›†å…§å®¹
const allWorkEntries = await getCollection("works", ({data}) => data.draft !== true); // Ensure drafts are filtered

// Identify unique base slugs
const uniqueBaseSlugs = new Set<string>();
allWorkEntries.forEach(work => {
  const slugParts = work.slug.split('/');
  if (slugParts.length > 1) {
    uniqueBaseSlugs.add(slugParts.slice(1).join('/'));
  } else {
    uniqueBaseSlugs.add(work.slug);
  }
});

// For each unique base slug, find the best version to display (current lang or default lang)
const worksToDisplay = Array.from(uniqueBaseSlugs).map(baseSlug => {
  let workEntry = allWorkEntries.find(w => w.slug === `${lang}/${baseSlug}`);
  if (!workEntry && lang !== defaultLang) {
    workEntry = allWorkEntries.find(w => w.slug === `${defaultLang}/${baseSlug}`);
  }
  return workEntry;
}).filter(work => work !== undefined) as CollectionEntry<"works">[]; // Filter out undefined and assert type

// Sort works, e.g., by date or title if desired (optional)
// worksToDisplay.sort((a, b) => new Date(b.data.started).getTime() - new Date(a.data.started).getTime());


// ç‚º banner å‹•ç•«æº–å‚™ä½œå“åœ–ç‰‡ (using worksToDisplay)
const workImages = worksToDisplay.map((work) => ({
  id: work.id, // This id will be from the actual entry found (could be defaultLang)
  cover: work.data.cover,
  title: work.data.title,
  // The slug for banner/navigation purposes should be the base slug, lang is separate
  slug: work.slug.substring(work.slug.indexOf('/') + 1),
}));

const images = import.meta.glob<{ default: ImageMetadata }>(
  "src/assets/works/**/*.{jpeg,jpg,png,gif}"
);
worksToDisplay.forEach((work) => { // Check images for worksToDisplay
  if (work.data.cover && !images[work.data.cover])
    throw new Error(
      `"${work.data.cover}" does not exist in glob: "src/assets/works/**/*.{jpeg,jpg,png,gif}"`
    );
});
---

<Base title={t("nav.works")} description="æˆ‘çš„ä½œå“é›†å±•ç¤º">
  <NavBar />
  <ProjectsBanner works={workImages} />
  <div class="transition-leaving w-full space-y-8">
    <main class="onload-animation">
      <section class="py-16 px-6 max-w-6xl mx-auto">
        <!-- ä½œå“ç¶²æ ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {
            worksToDisplay.map((work) => ( // Iterate over worksToDisplay
              <WorkCard
                title={work.data.title}
                description={work.data.description}
                cover={work.data.cover}
                tags={work.data.tags}
                slug={work.slug} // Pass the full slug of the found entry (e.g., "zh-tw/my-work")
                lang={lang} // Pass the current page language (e.g., "en")
              />
            ))
          }
        </div>

        <!-- å¦‚æžœæ²’æœ‰ä½œå“ -->
        {
          works.length === 0 && (
            <div class="text-center py-16">
              <div class="text-6xl mb-4">ðŸš§</div>
              <h3 class="text-2xl font-bold text-[var(--text-color)] mb-2">
                {t("works.empty")}
              </h3>
              <p class="text-[var(--text-color-lighten)]">
                {t("works.emptyDescription")}
              </p>
            </div>
          )
        }
      </section>
      <Footer />
    </main>
  </div>
</Base>
